@model LibSpace_Aspnet.Models.Livro

@{
    ViewData["Title"] = "Details";
}

<div class="DivGeneralDetails">
    <div class="upper-section">
        <div class="image-container">
            <!-- Div para a imagem -->
            <div>
                <img src="@Url.Content("~/Cover/" + Model.CapaImg)" alt="Imagem de @Model.CapaImg" class="image-details" />
            </div>

            <!-- Div para a descrição e botões -->
            <div class="description-wrapper">
                <p class="isbn">Ref: @Html.DisplayFor(model => model.Isbn)</p>
                <br />
                @if (User.IsInRole("Leitor"))
                {
                    @if (!ViewBag.IsFavorito)
                    {
                        <button id="favorite-button-@Model.IdLivro" class="favorite-button" data-livro-id="@Model.IdLivro">Adicionar Favorito</button>
                    }
                    else
                    {
                        <button id="Rfavorite-button-@Model.IdLivro" class="Rfavorite-button" data-livro-id="@Model.IdLivro">Remover Favorito</button>
                    }
                }
                @if (User.IsInRole("Admin"))
                {
                    <p class="isbn">Criado por: @ViewBag.BibliotecarioId</p>
                }
            </div>
        </div>
        <div class="DivInformation">
            <h4 class="textform_color">Nome: @Html.DisplayFor(model => model.TituloLivros)</h4>
            <p>de: @Html.DisplayFor(model => model.IdAutorNavigation.NomeAutor)</p>
            <hr />
            <p class="control-label textform_color"><strong>Editora:</strong> @Html.DisplayFor(model => model.IdEditoraNavigation.NomeEditora)</p>
            <p class="control-label textform_color"><strong>Sinopse:</strong></p>
            <p>@Html.Raw(Model.Sinopse?.Replace("\n", "<br />"))</p>
            <p class="control-label textform_color"><strong>Número de Exemplares Disponíveis:</strong> @Html.DisplayFor(model => model.NumExemplares)</p>
            <hr />
            <div class="action-links">
                @if (User.IsInRole("Bibliotecario"))
                {
                    <a asp-action="" asp-route-id="@Model?.IdAutor" class="btn_submit">Ver Requisitados</a>
                    <a asp-action="Edit" asp-route-id="@Model?.IdLivro" class="btn_submit">Editar Livro</a>
                    <a asp-action="Delete" asp-route-id="@Model?.IdLivro" class="btn_red">Eliminar Livro</a>
                }
                @if (!User.IsInRole("Bibliotecario") && !User.IsInRole("Admin"))
                {
                    @if (ViewBag.estreq == 0)
                    {
                        <a asp-action="Requisitar" asp-route-id="@Model?.IdLivro" class="btn_submit">Requisitar</a>
                    }
                    @if (ViewBag.estreq == 1)
                    {
                        <div>
                            <button class="btn_gray" disabled>A Aguardar Requisição</button>
                            <button id="cancel-prereq-@Model.IdLivro" class="btn_red" data-livro-id="@Model.IdLivro">Cancelar Pré-requisição</button>
                        </div>
                    }
                    @if (ViewBag.estreq == 2)
                    {
                        <button class="btn_gray" disabled>Requisitado - Aguarda Entrega</button>
                    }
                }
            </div>
        </div>
    </div>

    <div class="DivInformation1">
        <h4 class="textform_color">Nome: @Html.DisplayFor(model => model.TituloLivros)</h4>
        <hr />
        <p class="control-label textform_color">
            <strong>Autor:</strong> @Html.DisplayFor(model => model.IdAutorNavigation.Pseudonimo) <a asp-action="Details" asp-controller="Autors" asp-route-id="@Model.IdAutorNavigation.IdAutor">Ver detalhes do autor</a>
        </p>
        <p class="control-label textform_color"><strong>Editora:</strong> @Html.DisplayFor(model => model.IdEditoraNavigation.NomeEditora) <a asp-action="Details" asp-controller="Editoras" asp-route-id="@Model.IdEditoraNavigation.IdEditora">Ver detalhes da editora</a></p>
        <p class="control-label textform_color"><strong>Data de Edição:</strong> @Html.DisplayFor(model => model.DataEdicao)</p>
        <p class="control-label textform_color"><strong>Gênero:</strong> @Html.DisplayFor(model => model.IdGenerosNavigation.NomeGeneros)</p>
        <p class="control-label textform_color"><strong>País de Origem:</strong> @Html.DisplayFor(model => model.IdLinguaNavigation.NomePais)</p>
        <p class="control-label textform_color"><strong>Sinopse:</strong></p>
        <p>@Html.Raw(Model.Sinopse?.Replace("\n", "<br />"))</p>
    </div>
</div>

<br />
<div class="action-links">
    <button type="button" class="btn_submit" onclick="history.back()">Voltar</button>
</div>

@section Styles {
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Custom CSS for Details Page -->
    <link rel="stylesheet" href="~/css/details_design_livro.css" />
}

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
    .disabled {
        pointer-events: none; /* Desativa interações com o link */
        color: gray;         /* Muda a aparência visual */
        text-decoration: none;
    }
</style>
    <script>
        $(document).ready(function () {
            function atualizarBotaoFavorito(livroId, adicionar) {
                if (adicionar) {
                    $(`#favorite-button-${livroId}`)
                        .text('Adicionar Favorito')
                        .removeClass('Rfavorite-button')
                        .addClass('favorite-button');
                } else {
                    $(`#favorite-button-${livroId}`)
                        .text('Remover Favorito')
                        .removeClass('favorite-button')
                        .addClass('Rfavorite-button');
                }
            }

            // Função para adicionar favorito
            function adicionarFavorito(livroId) {
                $.ajax({
                    url: '@Url.Action("AdicionarFavorito", "Livroes")',
                    type: 'POST',
                    data: { idLivro: livroId },
                    success: function (response) {
                        if (response.success) {
                            alert(response.message);
                            atualizarBotaoFavorito(livroId, false);
                        } else {
                            alert(response.message || 'Erro ao adicionar favorito.');
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.error("Erro ao fazer a solicitação:", {
                            status: jqXHR.status,
                            statusText: textStatus,
                            error: errorThrown
                        });
                        alert(`Erro ao adicionar o favorito. Código: ${jqXHR.status}, Erro: ${errorThrown}`);
                    }
                });
            }

            // Função para remover favorito
            function removerFavorito(livroId) {
                $.ajax({
                    url: '@Url.Action("RemoverFavorito", "Livroes")',
                    type: 'POST',
                    data: { idLivro: livroId },
                    success: function (response) {
                        if (response.success) {
                            alert(response.message);
                            atualizarBotaoFavorito(livroId, true);
                        } else {
                            alert(response.message || 'Erro ao remover favorito.');
                        }
                    },
                    error: function () {
                        alert("Ocorreu um erro ao tentar remover o favorito.");
                    }
                });
            }

            // Event listeners para os botões de favorito
            $(document).on("click", ".favorite-button", function () {
                const livroId = $(this).data("livro-id");
                adicionarFavorito(livroId);
            });

            $(document).on("click", ".Rfavorite-button", function () {
                const livroId = $(this).data("livro-id");
                removerFavorito(livroId);
            });

            function cancelarPreRequisicao(livroId) {
                $.ajax({
                    url: '@Url.Action("CancelarPreRequisicao", "Livroes")',
                    type: 'POST',
                    data: { idLivro: livroId },
                    success: function (response) {
                        if (response.success) {
                            alert(response.message);
                            location.reload(); // Reload the page to update the status
                        } else {
                            alert(response.message || 'Erro ao cancelar pré-requisição.');
                        }
                    },
                    error: function () {
                        alert("Ocorreu um erro ao tentar cancelar a pré-requisição.");
                    }
                });
            }

            // Event listener for cancel button
            $(document).on("click", "[id^='cancel-prereq-']", function () {
                const livroId = $(this).data("livro-id");
                if (confirm("Tem certeza que deseja cancelar esta pré-requisição?")) {
                    cancelarPreRequisicao(livroId);
                }
            });
        });
    </script>

    <!-- Validation Scripts -->
    <partial name="_ValidationScriptsPartial" />
}

